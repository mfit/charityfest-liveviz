var socket=io.connect("/"),app=app||{},lg;$(function(){d3&&(lg=liveGraphApp())}),socket.on("update",function(d){lg&&lg.update(d)}),socket.on("layout",function(d){lg&&(console.log("Layout",d),lg.setChartActive(d.activeId))}),socket.on("init",function(d){});var liveGraphApp=function(){function getScale(height,max){return d3.scale.linear().domain([0,max]).range([0,height])}function BarChart(container,setup){function updateGraph(chart,newdata){var maxvalue=d3.max(newdata),maxindex=newdata.indexOf(maxvalue);maxvalue>maxY?(maxY=1.5*maxvalue,y=getScale(barHeight,maxY)):.4*maxY>maxvalue&&(maxY=.6*maxvalue,y=getScale(barHeight,maxY)),chart.selectAll("rect").data(newdata).transition().duration(750).ease("bounce").attr("y",function(d){return barHeight-y(d)}).attr("height",y).attr("class",function(d,i){return i==maxindex?"leader":""}),chart.selectAll("text.num").data(newdata).text(function(d){return d})}var div=container.append("div").attr("class",setup["class"]||""),chart=(div.append("h2").text(setup.title),div.append("svg").attr("class","chart")),data=setup.series||[],config=setup.config||{},maxY=config.maxVal||200,height=config.height||200,width=config.width||200,n=data.length||2,barBorder=config.spacing||4,barWidth=width/n,barHeight=height-40;console.log("setting up chart ... ",setup);var y=getScale(barHeight,maxY);chart.attr("width",barWidth*n).attr("height",height);var bar=chart.selectAll("g").data(data).enter().append("g").attr("transform",function(d,i){return"translate("+i*barWidth+", 0)"});return bar.append("rect").attr("width",barWidth-barBorder).attr("y",barHeight).attr("height",1),config.notext||(bar.append("text").attr("x",barWidth-barBorder-10).attr("y",barHeight-20).attr("dy",".35em").attr("class","num").text(function(d){return d}),setup.projects&&bar.append("text").data(setup.projects).attr("x",10).attr("y",barHeight+20).attr("dy",".35em").attr("class","title").text(function(d){return d.title})),updateGraph(chart,data),this.updateGraph=function(values){updateGraph(chart,values)},this.chart=chart,this}function mapChartConfig(cobj,layoutConfig,classtype){return{title:cobj.title,"class":[cobj["class"]||"",classtype,"session-"+cobj.id].join(" "),config:layoutConfig,projects:cobj.projects,series:cobj.projects.map(function(p){return p.value})}}function mapOverviewChartConfig(allStates,layoutConfig,classtype){var data=Object.keys(allStates).map(function(k){return allStates[k]}).map(function(obj){return obj.projects.map(function(p){return p.value})}).reduce(function(l,item){return l.concat(item)},[]);return layoutConfig.notext=!0,{title:"Overview","class":classtype,config:layoutConfig,series:data}}function createMainChart(cobj){return new BarChart(mainContainer,mapChartConfig(cobj,barConfigLarge,"large"))}function setChartActive(id,configObj){"undefined"!=typeof activeId&&d3.select(".side.session-"+activeId).style("display","block"),d3.selectAll(".large").remove(),activeId=id,configObj?activeChart=createMainChart(configObj):id in chartStates&&(activeChart=createMainChart(chartStates[id])),d3.select(".side.session-"+activeId).style("display","none")}var activeChart,activeId,overviewChart,sessionCharts={},chartStates={},container=d3.select(".chartlist"),mainContainer=d3.select(".mainchart"),barconfig={width:140,height:100,maxVal:200},barConfigLarge={width:500,height:400,maxVal:200,spacing:20};return d3.json("/setup",function(error,initialData){return error?alert(error):(initialData.forEach(function(cobj){var chart=new BarChart(container,mapChartConfig(cobj,barconfig,"side"));sessionCharts[cobj.id]=chart,chartStates[cobj.id]=cobj}),setChartActive(0,initialData[0]),void(overviewChart=new BarChart(container,mapOverviewChartConfig(chartStates,barconfig,"overview"))))}),{BarChart:BarChart,setChartActive:setChartActive,update:function(sessions){console.log("Recieved update : "),console.log(sessions),sessions.forEach(function(cobj){chartStates[cobj.id]=cobj,console.log(cobj);var flatValues=cobj.projects.map(function(p){return p.value});sessionCharts[cobj.id].updateGraph(flatValues),activeId==cobj.id&&activeChart.updateGraph(flatValues)}),overviewChart.updateGraph(mapOverviewChartConfig(chartStates,barconfig).series)}}};!function(){"use strict";angular.module("donationz",[]),angular.module("donationz").controller("DonationsCtrl",["DonationsData","$scope",function(DonationsData,$scope){var self=this;return this.don={amount:0},this.projects=[],this.projectLookup={},this.sessions=[{id:0},{id:1},{id:2},{id:3}],this.sessionLookup={},this.activeSessionId,DonationsData.getProjects().then(function(data){$scope.$apply(function(){self.projects=data,self.projectLookup=self.projects.reduce(function(dict,item){return dict[item.id]=item,dict},{})})})["catch"](function(err){console.log(err),alert("Could not load projects")}),DonationsData.getSessions().then(function(data){$scope.$apply(function(){self.sessions=data,self.sessionLookup=self.sessions.reduce(function(dict,item){return dict[item.id]=item,dict},{})})})["catch"](function(err){console.log(err),alert("Could not load sessions")}),DonationsData.fetchDonations().then(function(data){})["catch"](function(err){console.log(err),alert("Could not load donations")}),this.isSessionActive=function(id){return id==this.activeSessionId},this.activateSession=function(id){DonationsData.setSessionActive(id).then(function(){$scope.$apply(function(){self.activeSessionId=id})})["catch"](alert)},this.addDonation=function(){DonationsData.addDonation(this.don.amount,this.don.project).then(function(donation){$scope.$apply(function(){self.don.amount=0})})["catch"](function(){alert("Could not save donation")})},this.getDonations=function(){return DonationsData.getDonations().sort(function(a,b){return b.date-a.date})},this}]),angular.module("donationz").service("DonationsData",["$http","$q",function($http,$q){var base="/",data=[];return this.addDonation=function(amount,project){return new Promise(function(resolve,reject){var donationData={amount:amount,projectId:project};$http.post(base+"donation",donationData).success(function(donation){console.log("New donation"),console.log(donation),data.push(donation),resolve(donation)}).error(reject)})},this.getDonations=function(){return data},this.fetchDonations=function(){return new Promise(function(resolve,reject){$http.get(base+"donations").success(function(res){data=res,resolve(res)}).error(reject)})},this.getProjects=function(){return new Promise(function(resolve,reject){$http.get(base+"projects").success(resolve).error(function(res){console.log("Error!"),console.log(res),reject(res)})})},this.getSessions=function(){return new Promise(function(resolve,reject){$http.get(base+"sessions").success(resolve).error(reject)})},this.setSessionActive=function(sessionId){return new Promise(function(resolve,reject){$http.post(base+"layout",{activeId:sessionId}).success(resolve).error(reject)})},this}])}();